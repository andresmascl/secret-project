services:
  scrapbot:
    build: .
    container_name: scrapbot-ai
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true

    env_file:
      - .env

    # Run container with host UID/GID for audio/DBus; provide sane defaults
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"

    volumes:
      - /var/lib/dbus:/var/lib/dbus
      - .:/app
      # Map Pulse cookie to default lookup path inside container ($HOME/.config/pulse/cookie). For arbitrary UID, HOME is typically '/'.
      - ${HOME}/.config/pulse/cookie:/.config/pulse/cookie
      - /run/user/${USER_ID:-1000}/pulse/native:/run/user/${USER_ID:-1000}/pulse/native
      - /run/user/${USER_ID:-1000}/bus:/run/user/${USER_ID:-1000}/bus
      - /etc/machine-id:/etc/machine-id:ro

    environment:
      - PULSE_SERVER=unix:/run/user/${USER_ID:-1000}/pulse/native
      - XDG_RUNTIME_DIR=/run/user/${USER_ID:-1000}
      - DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/${USER_ID:-1000}/bus

    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      memlock: -1
    group_add:
      - audio
    restart: unless-stopped